<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>COVID Database | US Cases</title>
    <link rel="stylesheet" href="layout.css">
    <link rel="icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.anychart.com/geodata/latest/countries/united_states_of_america/united_states_of_america.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-map.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js"></script>
    <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css" type="text/css" rel="stylesheet">
  </head>

  <body>
    <aside id="sidebar">
      <i class="fas fa-search"></i>
        <input type="search" 
            placeholder="Search for Country" 
            id="search" 
            value="" />
      <section id="country-section">
          <h1>Country/State:</h1>
          <section id="country"><br></section>
      </section>
      <section id="case-section">
          <h1>Casesï¼š</h1>
          <section id="cases"><br></section>
      </section>
      <section id="death-section">
          <h1>Deaths:</h1>
          <section id="deaths"><br></section>
      </section>
      
    </aside>
    <main>
      <header>
        <img src="https://common.northwestern.edu/v8/css/images/northwestern.svg">
        <section class="buttons">
          <a href="index.html"><button id="casesmap">Global Cases</button></a>
          <a href="index2.html"><button id="deathsmap">Global Deaths</button></a>
          <a href="index3.html"><button id="usmap">US Cases</button></a>
          </section>
      </header>
    </main>
    <section id="mapbox">
        <div id="container"></div>
    </section>
    <footer>
        <h1>Resources</h1>
        <ul>
            <li ><a href="https://data.cdc.gov/resource/9mfq-cb36.json">CDC Data API</a></li>
            <li ><a href="https://coronavirus.jhu.edu/map.html">JHU COVID-19 Dashboard</a></li>
            <li ><a href="https://api.covid19api.com/">COVID19 API</a></li>
            
        </ul>
    </footer>
    <script type="text/javascript" src="js/scripts.js"></script>
    <script>
      var today = new Date();
      var lastupdate = new Date(today);
      url = 'https://data.cdc.gov/resource/9mfq-cb36.json?submission_date=' + lastupdate;

      lastupdate.setDate(lastupdate.getDate() - 3);
      
      var dd = String(lastupdate.getDate()).padStart(2, '0');
      var mm = String(lastupdate.getMonth() + 1).padStart(2, '0');
      var yyyy = lastupdate.getFullYear();
      lastupdate = yyyy + '-' + mm + '-' + dd;
      url = 'https://data.cdc.gov/resource/9mfq-cb36.json?submission_date=' + lastupdate;
      console.log(url);


      anychart.onDocumentReady(function () {
        anychart.data.loadJsonFile(
          url,
          function (data) {
            // create map chart
            var map = anychart.map();
            var geoData = data;
            var covidData = [];
            for (var i = 0; i < geoData.length; i++) {
            covidData.push({ id: 'US.'+geoData[i].state, value: geoData[i].tot_cases, title: geoData[i].state})
          };

  
            // settings for map chart
            map
              .background('rgb(128,128,128, 0.2)')
              .padding([10, 0, 10, 10])
              .geoData('anychart.maps.united_states_of_america')
              .interactivity({ selectionMode: 'none' });
  
            map
              .title()
              .enabled(true)
              .useHtml(true)
              .padding([10, 0, 10, 0])
              .text(
                'COVID Cases by State (Click on State for More Data)'
              );
  
            // create choropleth series for map chart
            var mapSeries = map.choropleth(anychart.data.set(covidData));
            mapSeries
              .geoIdField('code_hasc')
              .colorScale(
                anychart.scales.linearColor('#f2f2f2', '#42a5f5', '#1976d2')
              );
  
            mapSeries
              .hovered()
              .fill(mapSeries.fill())
              .stroke(mapSeries.stroke());
  
            // custom text in tooltips for choropleth series for map chart
            mapSeries
              .tooltip()
              .useHtml(true)
              .titleFormat('{%title}')
              .format(function () {
                var amount = this.getData('name');
                  amount =
                    '<span style="color: #d9d9d9;">' +
                    'There are <strong><span style="color: #fff;">' +
                    numberWithCommas(this.value) +
                    ' </span></strong>COVID cases in ' +
                    this.getData('title')
                return amount;
              });
            // onclick function for points - redirecting client (based on baseLink variable)
            map.listen('pointClick', function (e) {
              row=geoData[e.pointIndex]
              function numberWithCommas(x) {
              return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
              }
              document.querySelector('#cases').innerHTML=`<b>${numberWithCommas(row.tot_cases)}</b> <small>(+${numberWithCommas(parseInt(row.new_case))})</small>`;
              document.querySelector('#deaths').innerHTML=`<b>${numberWithCommas(row.tot_death)}</b> <small>(+${numberWithCommas(parseInt(row.new_death))})</small>`;
              document.querySelector('#country').innerHTML=`<b>${row.state}</b>`;
              map.zoomToFeature(e.point.get('id'));
            });
  
            // set container id for the chart
            map.container('container');
            // initiate chart drawing
            map.draw();
          }
        );
      });
    
    </script>
    
  </body>
</html>